# Rime schema
# encoding: utf-8
#
# AI 智能补全拼音输入方案
# 基于雾凇拼音（rime-ice），集成 AI 补全功能

schema:
  schema_id: ai_pinyin
  name: AI 拼音
  version: "1.0"
  author:
    - AI Completion Team
  description: |
    基于雾凇拼音（rime-ice）的 AI 智能补全输入方案
    按 Tab 键触发 AI 补全
  dependencies:
    - rime_ice

switches:
  - name: ascii_mode
    reset: 0
    states: [ 中文, 西文 ]
  - name: full_shape
    states: [ 半角, 全角 ]
  - name: simplification
    reset: 1  # 默认启用简化字（简体）
    states: [ 漢字, 汉字 ]
  - name: ascii_punct
    states: [ 。，, ., ]
  - name: ai_completion
    reset: 1
    states: [ "AI✗", "AI✓" ]

engine:
  processors:
    - lua_processor@ai_history_processor     # 历史记录捕获处理器（必须在最前面）
    - lua_processor@ai_completion_processor  # AI 补全处理器
    - ascii_composer
    - recognizer
    - key_binder
    - speller
    - punctuator
    - selector
    - navigator
    - express_editor
  segmentors:
    - ascii_segmentor
    - matcher
    - abc_segmentor
    - punct_segmentor
    - fallback_segmentor
  translators:
    - punct_translator
    - script_translator
    - table_translator@melt_eng                # 英文输入（沿用 rime-ice）
    - lua_translator@ai_completion_translator  # AI 补全翻译器
  filters:
    - lua_filter@ai_history_filter              # 历史记录捕获过滤器
    - lua_filter@*autocap_filter                # 英文自动大写（沿用 rime-ice）
    - lua_filter@*reduce_english_filter         # 降低部分英文短词权重
    - simplifier
    - uniquifier

# Speller 配置
speller:
  alphabet: zyxwvutsrqponmlkjihgfedcba
  delimiter: " '"
  algebra:
    - erase/^xx$/
    - abbrev/^([a-z]).+$/$1/
    - abbrev/^([zcs]h).+$/$1/
    - derive/^([nl])ve$/$1ue/
    - derive/^([jqxy])u/$1v/
    - derive/un$/uen/
    - derive/ui$/uei/
    - derive/iu$/iou/
    - derive/([aeiou])ng$/$1gn/
    - derive/([dtngkhrzcs])o(u|ng)$/$1o/
    - derive/ong$/on/
    - derive/ao$/oa/
    - derive/([iu])a(o|ng?)$/a$1$2/

# Translator 配置
translator:
  dictionary: rime_ice
  prism: ai_pinyin
  preedit_format:
    - xform/([nl])v/$1ü/
    - xform/([nl])ue/$1üe/
    - xform/([jqxy])v/$1u/

# 英文次翻译器（沿用雾凇拼音配置）
melt_eng:
  dictionary: melt_eng     # 挂载词库 melt_eng.dict.yaml
  enable_sentence: false   # 禁止造句
  enable_user_dict: false  # 禁用用户词典
  initial_quality: 0.4     # 初始权重（显著低于中文，让中文优先）
  comment_format:          # 自定义提示码
    - xform/.*//           # 清空提示码

# 降低部分英语单词在候选项的位置（配置与 rime_ice 保持一致）
reduce_english_filter:
  mode: all     # all | custom | none，使用内置短词集并合并 words
  idx: 4        # 降低到第 idx 个位置（至少前 3 位优先给中文）
  words: [
    aid, ann,
    bail, bait, bam, band, bans, bat, bay, bend, bent, benz, bib, bid, bien, biz, boc, bop, bos, bud, buf, bus, bach, bench, bush,
    cab, cad, cain, cam, cans, cap, cef, chad, chan, chap, chef, cher, chew, chic, chin, chip, chit, coup, cum, cunt, cur, couch,
    dab, dag, dal, dam, dent, dew, dial, diet, dim, din, dip, dis, dit, doug, dub, dug, dunn, don,
    fab, fax, fob, fog, foul, fur,
    gag, gail, gain, gal, gam, gaol, ged, gel, ger, guam, gus, gut,
    hail, ham, hank, hans, hat, hay, heil, heir, hem, hep, hex, hud, hum, hung, hunk, hut, hush,
    jim, jug,
    kat,
    lab, lad, lag, laid, lam, laos, lap, lat, lax, lay, led, leg, lex, liam, lib, lid, lied, lien, lies, linn, lip, lit, liz, lob, lug, lund, lung, lux, lash, loch, lush,
    mag, maid, mann, mar, mat, med, mel, mend, mens, ment, mil, mins, mint, mob, moc, mop, mos, mot, mud, mug, mum, mesh,
    nap, nat, nay, neil, nib, nip, noun, nous, nun, nut, nail, nash,
    pac, paid, pail, pain, pair, pak, pal, pam, pans, pant, pap, par, pat, paw, pax, pens, pic, pier, pies, pins, pint, pit, pix, pod, pop, pos, pot, pour, pow, pub, pinch, pouch,
    rand, rant, rent, rep, res, ret, rex, rib, rid, rig, rim, rub, rug, rum, runc, runs, ranch,
    sac, sail, sal, sam, sans, sap, saw, sax, sew, sham, shaw, shin, sig, sin, sip, sis, suit, sung, suns, sup, sur, sus,
    tad, tail, taj, tar, tax, tec, ted, tel, ter, tex, tic, tied, tier, ties, tim, tin, tit, tour, tout, tum,
    wag, wand, womens, wap, wax, weir, won, went,
    yan, yen,
    zach,
    my, mt, dj, as, js, cs, ak, ps, cd, cn, hk, bt, pk, ml
  ]

# AI 补全配置
ai_completion:
  # 是否启用 AI 补全
  enabled: true

  # 触发快捷键 (Tab, Control+space, 等)
  # 使用 Tab 键触发 AI 补全
  trigger_key: "Tab"

  # AI 模型配置
  base_url: "https://api.openai.com/v1/chat/completions"
  api_key: "YOUR_API_KEY_HERE"
  model_name: "gpt-4o-mini"

  # 上下文窗口（分钟）- 改为 10 分钟
  context_window_minutes: 10

  # 最大候选数量
  max_candidates: 3

  # 提示词模板
  system_prompt: "你是一个智能中文输入法助手。用户会提供最近10分钟输入的中文文本作为上下文，以及当前正在输入的拼音。你需要根据上下文推测用户想要输入的完整中文句子或短语。只返回中文文本，返回3个最可能的补全选项，每个选项一行。"

# 按键绑定
key_binder:
  import_preset: default
  bindings:
    # 禁用 Tab 键的默认功能（移动光标），改为触发 AI 补全
    - { when: composing, accept: Tab, send: Tab }
    # 禁用 Shift+Tab
    - { when: composing, accept: Shift+Tab, send: Shift+Tab }

# 识别器配置
recognizer:
  import_preset: default
  patterns:
    punct: "^/([0-9]0?|[a-z]+)$"
    reverse_lookup: "`[a-z]*'?$"
    url: "^(www[.]|https?:|ftp[.:]|mailto:|file:).*$|^[a-z]+[.].+$"

# 标点符号：沿用雾凇拼音的默认设置
punctuator:
  __include: default:/punctuator

# Lua 扩展配置
# 指定 Lua 脚本位置
lua:
  ai_completion_processor: "ai_completion.processor"
  ai_completion_translator: "ai_completion.translator"
