#!/bin/bash
set -e

login_user=`/usr/bin/stat -f%Su /dev/console`
squirrel_app_root="${DSTROOT}/Squirrel.app"
squirrel_executable="${squirrel_app_root}/Contents/MacOS/Squirrel"
rime_package_installer="${squirrel_app_root}/Contents/MacOS/rime-install"
rime_shared_data_path="${squirrel_app_root}/Contents/SharedSupport"

/usr/bin/sudo -u "${login_user}" /usr/bin/killall Squirrel > /dev/null || true

"${squirrel_executable}" --register-input-source

# Install bundled Rime ICE Lua plugins, AI 脚本和 emoji opencc 数据
user_home="/Users/${login_user}"
user_rime_dir="${user_home}/Library/Rime"

/usr/bin/sudo -u "${login_user}" /bin/mkdir -p "${user_rime_dir}/lua" "${user_rime_dir}/opencc"

# Copy Lua plugins (skip rime.lua itself; do not overwrite existing user files)
for lua_file in "${rime_shared_data_path}"/*.lua; do
    if [ -f "${lua_file}" ]; then
        lua_base="$(basename "${lua_file}")"
        if [ "${lua_base}" = "rime.lua" ]; then
            continue
        fi
        /usr/bin/sudo -u "${login_user}" /bin/cp -n "${lua_file}" "${user_rime_dir}/lua/" || true
    fi
done

# Install AI 核心脚本 rime.lua 到用户根目录（仅在不存在时）
if [ -f "${rime_shared_data_path}/rime.lua" ]; then
    /usr/bin/sudo -u "${login_user}" /bin/cp -n "${rime_shared_data_path}/rime.lua" "${user_rime_dir}/rime.lua" || true
fi

# Copy emoji opencc configs (do not overwrite existing user files)
for opencc_file in emoji.json emoji.txt others.txt; do
    if [ -f "${rime_shared_data_path}/${opencc_file}" ]; then
        /usr/bin/sudo -u "${login_user}" /bin/cp -n "${rime_shared_data_path}/${opencc_file}" "${user_rime_dir}/opencc/" || true
    fi
done

# Ensure the rest of the opencc converters are available locally (fallback when configs reference user opencc paths)
if [ -d "${rime_shared_data_path}/opencc" ]; then
    for shared_opencc in "${rime_shared_data_path}/opencc"/*; do
        if [ -f "${shared_opencc}" ]; then
            opencc_name="$(basename "${shared_opencc}")"
            if [ ! -f "${user_rime_dir}/opencc/${opencc_name}" ]; then
                /usr/bin/sudo -u "${login_user}" /bin/cp "${shared_opencc}" "${user_rime_dir}/opencc/" || true
            fi
        fi
    done
fi

# Seed AI 配置模板（如用户不存在则复制示例并提供默认配置文件）
if [ -f "${rime_shared_data_path}/ai_pinyin.custom.yaml.example" ]; then
    /usr/bin/sudo -u "${login_user}" /bin/cp -n "${rime_shared_data_path}/ai_pinyin.custom.yaml.example" "${user_rime_dir}/ai_pinyin.custom.yaml.example" || true
    if [ ! -f "${user_rime_dir}/ai_pinyin.custom.yaml" ]; then
        /usr/bin/sudo -u "${login_user}" /bin/cp "${rime_shared_data_path}/ai_pinyin.custom.yaml.example" "${user_rime_dir}/ai_pinyin.custom.yaml" || true
    fi
fi

# 确保必要的 AI 方案资源可用（依赖仍然从共享目录加载）
for shared_file in symbols_v.yaml ai_pinyin.schema.yaml; do
    if [ -f "${rime_shared_data_path}/${shared_file}" ]; then
        /usr/bin/sudo -u "${login_user}" /bin/cp -n "${rime_shared_data_path}/${shared_file}" "${user_rime_dir}/${shared_file}" || true
    fi
done

# 复制 default.custom.yaml 到用户目录（启用 AI 拼音方案）
if [ -f "${rime_shared_data_path}/default.custom.yaml" ]; then
    /usr/bin/sudo -u "${login_user}" /bin/cp -n "${rime_shared_data_path}/default.custom.yaml" "${user_rime_dir}/default.custom.yaml" || true
fi

# 拷贝 rime-ice 依赖的 cn_dicts/en_dicts（若用户目录缺失核心词库）
if [ -d "${rime_shared_data_path}/cn_dicts" ]; then
    if [ ! -f "${user_rime_dir}/cn_dicts/8105.dict.yaml" ]; then
        /usr/bin/sudo -u "${login_user}" /bin/mkdir -p "${user_rime_dir}/cn_dicts"
        /usr/bin/sudo -u "${login_user}" /usr/bin/ditto "${rime_shared_data_path}/cn_dicts" "${user_rime_dir}/cn_dicts"
    fi
    # 兼容旧版 rime_ice.dict.yaml（引用根目录 8105/base/ext/...）
    for legacy_dict in 8105.dict.yaml base.dict.yaml ext.dict.yaml tencent.dict.yaml others.dict.yaml; do
        if [ ! -f "${user_rime_dir}/${legacy_dict}" ] && [ -f "${rime_shared_data_path}/cn_dicts/${legacy_dict}" ]; then
            /usr/bin/sudo -u "${login_user}" /bin/cp "${rime_shared_data_path}/cn_dicts/${legacy_dict}" "${user_rime_dir}/${legacy_dict}" || true
        fi
    done
fi

if [ -d "${rime_shared_data_path}/en_dicts" ]; then
    if [ ! -f "${user_rime_dir}/en_dicts/en.dict.yaml" ]; then
        /usr/bin/sudo -u "${login_user}" /bin/mkdir -p "${user_rime_dir}/en_dicts"
        /usr/bin/sudo -u "${login_user}" /usr/bin/ditto "${rime_shared_data_path}/en_dicts" "${user_rime_dir}/en_dicts"
    fi
fi

# 预构建 Rime 资源，确保安装后即可使用
if [ -z "${RIME_NO_PREBUILD}" ]; then
    /usr/bin/sudo -u "${login_user}" /bin/mkdir -p "${user_rime_dir}/build"
    /usr/bin/sudo -u "${login_user}" /usr/bin/env \
        RIME_SHARED_DATA_DIR="${rime_shared_data_path}" \
        RIME_USER_DATA_DIR="${user_rime_dir}" \
        "${squirrel_app_root}/Contents/MacOS/rime_deployer" --build \
            "${user_rime_dir}" \
            "${rime_shared_data_path}" \
            "${user_rime_dir}/build"
fi

(
    /usr/bin/sudo -u "${login_user}" "${squirrel_executable}" --enable-input-source
    /usr/bin/sudo -u "${login_user}" "${squirrel_executable}" --select-input-source
)
